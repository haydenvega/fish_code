---
title: "pam_code"
author: "Hayden Vega & Adrian Stier"
date: "2025-05-30"
output: html_document
description: An analysis of PAM data from the fish regen project. Included are visualizations, linear models, ANOVAs, Tukey tests, and randomization tests. 
---

# Setup
```{r}
#............................packages............................
library(janitor)
library(tidyverse)
library(viridis)
library(lme4)
library(ggeffects)
library(sjlabelled)
library(DHARMa)
library(parameters)
library(effects)
library(MuMIn)
library(here)
library(tidyverse)
library(gt)
library(broom.mixed)
library(ggpubr)


#..........................loading data..........................
pam_healed <- read.csv(here("data", "pam_healed.csv"))

pam_undisturbed_tissue_wound_no_wound <- read.csv(here("data", "pam_undisturbed_healed.csv"))

pam_undisturbed_healed_tissue_wound_no_wound <- read.csv(here("data","pam_undisturbed_healed_tissue_wound_no_wound.csv"))

#.......................loading aesthetics.......................
wound_palette <- c("Large" = "#ffbf00", 
                   "Small" = "#be8333", 
                   "No Wound" = "#f57a38" )
fish_palette <- c("Fish" = "#2b4b52", 
                  "No Fish" = "#ad301a")
pam_undisturbed_healed_tissue_wound_no_wound$fish <- factor(
  pam_undisturbed_healed_tissue_wound_no_wound$fish,
  levels = c("No Fish", "Fish"))

pam_undisturbed_healed_tissue_wound_no_wound$wound <- factor(
  pam_undisturbed_healed_tissue_wound_no_wound$wound,
  levels = c("Large", "Small", "No Wound")  # desired order
)
```


## Visualizing Fv/Fm by wound and fish presence

### Fv_Fm as a function of fish presence--colored by wound
```{r}
ggplot(pam_healed, aes(x = fish, y = fv_fm, fill = wound)) +
  geom_boxplot() +
  #geom_smooth(method = "lm", se = FALSE, linewidth = 1.1) +
  scale_fill_manual(values = wound_palette) +
  labs(
    title = "Coral Photosynthetic Efficiency as a Function of Fish Presence",
    subtitle = "Colored by Wound Treatment",
    x = "Fish Presence",
    y = "Photosynthetic Efficiency (fv/fm)",
    color = "Wound Treatment"
  ) +
  theme_pubr(base_size = 14)+
  theme(
    plot.title = element_text(hjust = 1), 
    plot.subtitle = element_text(hjust= -0.05)
  )

ggsave(
  here("figures", "photoeff_vs_fish.png"),
  width = 8,
  height = 6,
  dpi = 300
)
```

### Fv_Fm as a function of wound presence--colored by fish presence
```{r}
ggplot(pam_healed, aes(x = wound, y = fv_fm, fill = fish)) +
  geom_boxplot() +
  #geom_smooth(method = "lm", se = FALSE, linewidth = 1.1) +
  scale_fill_manual(values = fish_palette) +
  labs(
    title = "Coral Photosynthetic Efficiency as a Function of Wound Size",
    subtitle = "Colored by Fish Presence",
    x = "Wound Size",
    y = "Photosynthetic Efficiency (fv/fm)",
    color = "Fish Presence"
  ) +
  theme_pubr(base_size = 14)

ggsave(
  here("figures", "photoeff_vs_wound.png"),
  width = 8,
  height = 6,
  dpi = 300
)



#Based on both graphs above, I think there may be a significant interaction between large wounds and fish presence.


# Enforce correct factor ordering for all downstream plots
pam_healed <- pam_healed %>%
  mutate(
    wound = factor(wound, levels = c("Small", "Large")),
    fish = factor(fish, levels = c("No Fish", "Fish"))
  )
ggplot(pam_healed, aes(x = wound, y = fv_fm, fill = fish)) +
  geom_violin(position = position_dodge(0.9), alpha = 0.3, color = NA) +
  geom_boxplot(
    position = position_dodge(0.9), 
    width = 0.3, 
    outlier.shape = NA, 
    color = "black",
    alpha = 0.8
  ) +
  geom_jitter(
    aes(color = fish),
    position = position_jitterdodge(jitter.width = 0.15, dodge.width = 0.9),
    size = 2, 
    alpha = 0.5
  ) +
  scale_fill_manual(values = fish_palette) +
  scale_color_manual(values = fish_palette) +
  labs(
    title = "Coral Photosynthetic Efficiency vs Wound Size",
    subtitle = "Colored by Fish Presence",
    x = "Wound Size",
    y = "Photosynthetic Efficiency (Fv/Fm)",
    fill = "Fish Presence",
    color = "Fish Presence"
  ) +
  theme_bw(base_size = 18) +
  theme(
    plot.title = element_text(size = 20, face = "bold"),
    plot.subtitle = element_text(size = 16),
    axis.text = element_text(size = 16),
    axis.title = element_text(size = 18),
    legend.title = element_text(size = 16),
    legend.text = element_text(size = 15)
  )

ggsave(
  here("figures", "photoeff_vs_wound_violin_screen.png"),
  width = 7, height = 5, dpi = 150
)

```
# Boxplot with different wounds on different panels, colored by fish. 

```{r}

pam_undisturbed_healed_tissue_wound_no_wound %>%
  mutate(wound = fct_reorder(wound, desc(fv_fm))) %>%
  ggplot(aes(wound, fv_fm, fill = fish)) +
  geom_boxplot(
    position = position_dodge(0.9), 
    width = 0.3, 
    outlier.shape = NA, 
    color = "black",
    alpha = 0.8
  ) +
  geom_jitter(
    aes(color = fish),
    position = position_jitterdodge(jitter.width = 0.15, dodge.width = 0.9),
    size = 2, 
    alpha = 0.5
  ) +
  scale_fill_manual(
    values = fish_palette,
    breaks = c("No Fish", "Fish")
  ) +
  scale_color_manual(
    values = fish_palette,
    breaks = c("No Fish", "Fish")
  ) +
  labs(
    title = "Coral Photosynthetic Efficiency vs Wound Size",
    x = "Wound Size",
    y = "Photosynthetic Efficiency (Fv/Fm)",
    fill = "Fish Presence",
    color = "Fish Presence"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.title = element_text(size = 12, face = "bold"),
    axis.text.x = element_text(size = 10),
    axis.text.y = element_text(size = 10),
    legend.position = "top",
    legend.direction = "horizontal", 
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 12),
    plot.title = element_text(size = 15, face = "bold"),
    plot.subtitle = element_text(size = 12), 
    axis.line.x = element_line(color = "black", size = 0.5),
    axis.line.y = element_line(color = "black", size = 0.5), 
    axis.title.x = element_text(size = 12), 
    axis.ticks.y = element_line(color = "black", size = 0.3)
  ) +
  scale_x_discrete(limits = rev)

ggsave(
  here("figures", "pam", "photoeff_vs_wound_box_all_wound.pdf"),
  width = 7, height = 5, dpi = 150
)

```
## Summary Line Plot of FV/FM by fish
```{r}
pam_line_plot_fish <- pam_undisturbed_healed_tissue_wound_no_wound %>% 
  ggplot(aes(x = wound, y = fv_fm, color = fish, group = fish, shape = fish)) +
  
  # Jittered points, dodged by fish
  geom_jitter(
    alpha = 0.25,
    size = 2.5, 
    position = position_jitterdodge(
      jitter.width = 0.1, 
      dodge.width = 0.6
    )
  ) +
  
  # Mean points per fish (dodged)
  stat_summary(
    fun = mean, 
    geom = "point", 
    size = 5, 
    position = position_dodge(width = 0.6)
  ) +
  
  # Error bars (mean ± SD, dodged, no horizontal caps)
  stat_summary(
    fun.data = function(x) {
      data.frame(
        y = mean(x),
        ymin = mean(x) - sd(x),
        ymax = mean(x) + sd(x)
      )
    },
    geom = "errorbar",
    width = 0,                
    size = 1,
    position = position_dodge(width = 0.6)
  ) +
  
  # Color palette
  scale_color_manual(values = fish_palette) +
  scale_shape_manual(values = c(16,18))+
  
  # Y-axis limits
  scale_y_continuous(limits = c(0.5, 0.750)) +
  
  # Labels & theme
  labs(
    y = "Photosynthetic Efficiency (Fv/Fm)",
    x = "Wound Size"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.title = element_text(size = 15, face = "bold"),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 10),
    legend.position = "none",
    axis.line.x = element_line(color = "black", size = 0.5),
    axis.line.y = element_line(color = "black", size = 0.5)
  )

ggsave(
  filename = here("figures", "pam", "summary_line_fv_fm_by_wound_fish.pdf"),
  plot = pam_line_plot_fish,
  width = 7,
  height = 5,
  dpi = 300
)
```


## Summary Line Plot of FV/FM by wound
```{r}
pam_line_plot_wound <- ggplot(pam_undisturbed_healed_tissue_wound_no_wound,  aes(x = wound, y = fv_fm, color = wound)) +
  geom_jitter(alpha = 0.5, width = 0.1, size = 2.5, shape = 16)+
  # Median point per group
  stat_summary(fun = mean, geom = "point", size = 5) +
  # Whiskers (median ± IQR) without horizontal caps
 stat_summary(
  fun.data = function(x) {
    data.frame(
      y = mean(x),
      ymin = mean(x) - sd(x),
      ymax = mean(x) + sd(x)
    )
  },
  geom = "errorbar",
  width = 0,
  size = 1
) +
  scale_color_manual(values = wound_palette) +
  scale_y_continuous(limits = c(0.500, 0.7500)) +
  theme_minimal() +
   theme(
    panel.grid = element_blank(),
    axis.title = element_text(size = 15, face = "bold"),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 10),
    legend.position = "top",
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 13),
    plot.title = element_text(size = 20, face = "bold"),
    plot.subtitle = element_text(size = 15), 
    axis.line.x = element_line(color = "black", size = 0.5),
    axis.line.y = element_line(color = "black", size = 0.5), 
    axis.title.x = element_blank(),
    legend.axis.line = element_blank()
  )+
  labs(
    y = "Photosynthetic Efficiency (Fv/Fm)", 
    color = "Wound Size"
  )
pam_line_plot_wound

ggsave(
  filename = here("figures", "pam", "summary_line_fv_fm_by_wound.pdf"),
  plot = pam_line_plot_wound,
  width = 7,
  height = 5,
  dpi = 300
)
```
### Summary line by fish only
```{r}
pam_line_plot_fish <- ggplot(pam_undisturbed_healed_tissue_wound_no_wound,  aes(x = fish, y = fv_fm, color = fish)) +
  geom_jitter(alpha = 0.5, width = 0.1, size = 2.5, shape = 16)+
  # Median point per group
  stat_summary(fun = mean, geom = "point", size = 5) +
  # Whiskers (median ± IQR) without horizontal caps
 stat_summary(
  fun.data = function(x) {
    data.frame(
      y = mean(x),
      ymin = mean(x) - sd(x),
      ymax = mean(x) + sd(x)
    )
  },
  geom = "errorbar",
  width = 0,
  size = 1
) +
  scale_color_manual(values = fish_palette) +
  scale_y_continuous(limits = c(500, 800)) +
  theme_minimal() +
   theme(
    panel.grid = element_blank(),
    axis.title = element_text(size = 15, face = "bold"),
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 10),
    legend.position = "top",
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 13),
    plot.title = element_text(size = 20, face = "bold"),
    plot.subtitle = element_text(size = 15), 
    axis.line.x = element_line(color = "black", size = 0.5),
    axis.line.y = element_line(color = "black", size = 0.5), 
    axis.title.x = element_blank(),
    legend.axis.line = element_blank()
  )+
  labs(
    y = "Photosynthetic Efficiency (Fv/Fm)", 
    color = "Fish Presence"
  )
pam_line_plot_fish

ggsave(
  filename = here("figures", "pam", "summary_line_fv_fm_by_fish.pdf"),
  plot = pam_line_plot_fish,
  width = 7,
  height = 5,
  dpi = 300
)
```


## Linear Models and Anova for Fv/Fm
### Fitting Mixed Effect Models
```{r}

# Full Model OH YEAH
mod_int <- lmer(fv_fm ~ fish * wound + (1 | tank), data = pam_healed)

summary(mod_int)

# Additive model without interaction
mod_add <- lmer(fv_fm ~ fish + wound + (1 | tank), data = pam_healed)

# Fish-only model
mod_fish <- lmer(fv_fm ~ fish + (1 | tank), data = pam_healed)

# Wound-only model
mod_wound <- lmer(fv_fm ~ wound + (1 | tank), data = pam_healed)

# Null model (intercept + tank)
mod_null <- lmer(fv_fm ~ 1 + (1 | tank), data = pam_healed)

```

### Likelihood tests
```{r}
lrt_interaction <- anova(mod_add, mod_int, test = "Chisq")
lrt_fish <- anova(mod_wound, mod_add, test = "Chisq")
lrt_wound <- anova(mod_fish, mod_add, test = "Chisq")
```

### Summarize results in a table
```{r}
lrt_table <- tibble(
  Test = c("Interaction (Fish × Wound)", "Fish Effect", "Wound Effect"),
  ChiSq = c(
    lrt_interaction$Chisq[2],
    lrt_fish$Chisq[2],
    lrt_wound$Chisq[2]
  ),
  Df = c(
    lrt_interaction$Df[2],
    lrt_fish$Df[2],
    lrt_wound$Df[2]
  ),
  p_value = c(
    lrt_interaction$`Pr(>Chisq)`[2],
    lrt_fish$`Pr(>Chisq)`[2],
    lrt_wound$`Pr(>Chisq)`[2]
  )
) %>%
  mutate(across(where(is.numeric), round, 3))

# Format with gt
lrt_table %>%
  gt() %>%
  tab_header(
    title = "Table #. Likelihood Ratio Tests for Effects on fv/fm",
    #subtitle = paste("Scaled growth:", expression((final - initial)/initial^b))
  ) %>%
  cols_label(
    Test = "Model Comparison",
    ChiSq = "Chi-squared",
    Df = "Degrees of Freedom",
    p_value = "P-value"
  ) %>%
  fmt_number(columns = vars(ChiSq, p_value), decimals = 3) %>%
  tab_options(
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 13
  )


```

### Averaging values 

```{r}
pam_avg_wound <- pam_healed %>%
  group_by(wound) %>%
  summarize(mean_fvfm = mean(fv_fm, na.rm = TRUE), 
  sd_fvfm = sd(fv_fm, na.rm = TRUE),
            n = n()) 
pam_avg_fish <- pam_healed %>% 
  group_by(fish) %>% 
  summarize(mean_fish = mean(fv_fm, na.rm = TRUE), 
  sd_fish = sd(fv_fm, na.rm = TRUE), 
            n = n())

pam_avg <- pam_healed %>% 
  group_by(fish, wound) %>% 
  summarize(mean_fv_fm = mean(fv_fm, na.rm = TRUE), 
            sd = sd(fv_fm, na.rm = TRUE), 
            n = n())
```
#Models with FV/fM and continuous wound size (initial_wound_size)

```{r}
rate_full <- lmer(
  fv_fm ~ fish * initial_wound_size + (1 | tank),
  data = pam_healed
)


rate_no_interaction <- lmer(
  fv_fm ~ fish + initial_wound_size + (1 | tank),  # 
  data = pam_healed
)


rate_no_fish <- lmer(
  fv_fm ~ initial_wound_size + (1 | tank),  # 
  data = pam_healed
)

rate_no_wound <- lmer(
  fv_fm ~ fish + (1 | tank),  
  data = pam_healed
)


lrt_interaction_zero_rate <- anova(rate_no_interaction, rate_full, test = "Chisq")
lrt_fish_zero_rate <- anova(rate_no_fish, rate_no_interaction, test = "Chisq")
lrt_wound_zero_rate <- anova(rate_no_wound, rate_no_interaction, test = "Chisq")

lrt_table <- tibble(
  Test = c("Interaction (Fish × Wound)", "Fish Effect", "Wound Effect"),
  ChiSq = c(lrt_interaction_zero_rate$Chisq[2],
            lrt_fish_zero_rate$Chisq[2],
            lrt_wound_zero_rate$Chisq[2]),
  Df = c(lrt_interaction_zero_rate$Df[2],
         lrt_fish_zero_rate$Df[2],
         lrt_wound_zero_rate$Df[2]),
  p_value = c(lrt_interaction_zero_rate$`Pr(>Chisq)`[2],
              lrt_fish_zero_rate$`Pr(>Chisq)`[2],
              lrt_wound_zero_rate$`Pr(>Chisq)`[2])
) %>%
  mutate(across(where(is.numeric), round, 3))

lrt_table %>%
  gt() %>%
  tab_header(
    title = "Table #. Likelihood Ratio Tests for Effects on Healing Rate",
  ) %>%
  cols_label(
    Test = "Model Comparison",
    ChiSq = "Chi-squared",
    Df = "Degrees of Freedom",
    p_value = "P-value"
  ) %>%
  fmt_number(columns = vars(ChiSq, p_value), decimals = 3) %>%
  tab_options(
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 13
  )
```


#Same analysis as above, but with non-wounded corals added to the data
## Linear Models and Anova for Fv/Fm
### Fitting Mixed Effect Models
```{r}

# Full Model
rate_full_no_wound <- lmer(
  fv_fm ~ fish * wound + (1 | tank),
  data = pam_undisturbed_healed_tissue_wound_no_wound
)


rate_no_interaction_no_wound <- lmer(
  fv_fm ~ fish + wound + (1 | tank),  # 
  data = pam_undisturbed_healed_tissue_wound_no_wound
)


rate_no_fish_no_wound <- lmer(
  fv_fm ~ wound + (1 | tank),  # 
  data = pam_undisturbed_healed_tissue_wound_no_wound
)

rate_no_wound_no_wound <- lmer(
  fv_fm ~ fish + (1 | tank),  
  data = pam_undisturbed_healed_tissue_wound_no_wound
)


lrt_interaction_zero_rate_no_wound <- anova(rate_no_interaction_no_wound, rate_full_no_wound, test = "Chisq")
lrt_fish_zero_rate_no_wound <- anova(rate_no_fish_no_wound, rate_no_interaction_no_wound, test = "Chisq")
lrt_wound_zero_rate_no_wound <- anova(rate_no_wound_no_wound, rate_no_interaction_no_wound, test = "Chisq")

lrt_table_fv_fm_all <- tibble(
  Test = c("Interaction (Fish × Wound)", "Fish Effect", "Wound Effect"),
  ChiSq = c(lrt_interaction_zero_rate_no_wound$Chisq[2],
            lrt_fish_zero_rate_no_wound$Chisq[2],
            lrt_wound_zero_rate_no_wound$Chisq[2]),
  Df = c(lrt_interaction_zero_rate_no_wound$Df[2],
         lrt_fish_zero_rate_no_wound$Df[2],
         lrt_wound_zero_rate_no_wound$Df[2]),
  p_value = c(lrt_interaction_zero_rate_no_wound$`Pr(>Chisq)`[2],
              lrt_fish_zero_rate_no_wound$`Pr(>Chisq)`[2],
              lrt_wound_zero_rate_no_wound$`Pr(>Chisq)`[2])
) %>%
  mutate(across(where(is.numeric), round, 3))

# Format with gt
lrt_table_fv_fm_all %>%
  gt() %>%
  tab_header(
    title = "Table #. Likelihood Ratio Tests for Effects on Fv/Fm",
    #subtitle = paste("Scaled growth:", expression((final - initial)/initial^b))
  ) %>%
  cols_label(
    Test = "Model Comparison",
    ChiSq = "Chi-squared",
    Df = "Degrees of Freedom",
    p_value = "P-value"
  ) %>%
  fmt_number(columns = vars(ChiSq, p_value), decimals = 3) %>%
  tab_options(
    table.font.size = 14,
    heading.title.font.size = 16,
    heading.subtitle.font.size = 13
  )

gtsave(
  data = lrt_table %>% gt() %>% tab_header(title = "Likelihood Ratio Tests for fv/fm"),
  filename = "C:/Users/vegah/OneDrive/Desktop/fish_code/fish_code/fish_code/figures/pam/fv_fm_lrt_table_all_wounds_included.html"
)

```
## Averaging values for the above data
```{r}
# Wounds
fv_fm_avg_wound <- pam_undisturbed_healed_tissue_wound_no_wound %>%
  group_by(wound) %>%
  summarize(mean_fv_fm = mean(fv_fm, na.rm = TRUE), 
  sd_wound_rate = sd(fv_fm, na.rm = TRUE),
            n = n()) 
# small = 665.5 +/- 36.43
# large = 658.7 +/- 36.86
# NW = 684.7 +/- 11.64

#Fish
rate_avg_fish <- pam_undisturbed_healed_tissue_wound_no_wound %>% 
  group_by(fish) %>% 
  summarize(mean_fv_fm = mean(fv_fm, na.rm = TRUE), 
  sd_fish_rate = sd(fv_fm, na.rm = TRUE), 
            n = n())
#no_fish = 657.9 */- 38.41
#fish = 681.4 +/- 15.53

# Interaction
pam_avg <- pam_undisturbed_healed_tissue_wound_no_wound %>% 
  group_by(fish, wound) %>% 
  summarize(mean_fv_fm = mean(fv_fm, na.rm = TRUE), 
            sd_both_rate = sd(fv_fm, na.rm = TRUE), 
            n = n())
	
# No Fish
# Large
# 0.6331667
# 0.03568507
# 12
# 2
# No Fish
# Small
# 0.6570833
# 0.04346254
# 12
# 3
# No Fish
# No Wound
# 0.6835833
# 0.01205637
# 12
# 4
# Fish
# Large
# 0.6844167
# 0.01162645
# 12
# 5
# Fish
# Small
# 0.6740000
# 0.02701851
# 12
# 6
# Fish
# No Wound
# 0.6859167
# 0.01163426
```




#Algae influences on fv/fm
# Visualizing Corals with Algae
```{r}
ggplot(pam_healed, aes(x = algae, y = fv_fm, fill = fish))+
  geom_boxplot()+
  geom_jitter()

ggplot(pam_healed, aes(x = algae, y = fv_fm, fill = wound))+
  geom_boxplot()+
  geom_jitter()

#SUMMARY HERE IS THAT THERE ARE 1 FISH & ALGAE CORAL, 7 NO FISH AND ALGAE CORALS
#OVERALL PHOTOSYNTHETIC EFFICIENCY IS LOWER, PROBABLY BECAUSE THEY'RE NO FISH
#IF ALGAE DID PLAY A ROLE, THEN IT should BE HIGHER ? 

```
##Use models to determine if there is an algae effect
```{r}
# Full Model 
mod_int_algae <- lmer(fv_fm ~ fish * wound * algae + (1 | tank), data = pam_healed)

# Additive model without interaction
mod_add_algae <- lmer(fv_fm ~ fish * wound + algae + (1 | tank), data = pam_healed)

# Fish-only model
mod_algae <- lmer(fv_fm ~ algae + (1 | tank), data = pam_healed)



##LRT TESTS

lrt_interaction_algae <- anova(mod_algae, mod_int_algae, test = "Chisq")
lrt_algae <- anova(mod_algae, mod_add_algae, test = "Chisq")

view(lrt_algae)

#NO SIGNIFICANT effect of algae p value = 0.106

```















# OLD CODE

### Boxplot of Pam for undisturbed tissue
```{r}


pam_undisturbed_tissue_wound_no_wound %>% 
  ggplot(aes (x = fish, y = fv_fm, fill = fish)) +
  geom_boxplot()+
  theme_bw()

  ## Boxplot of PAM including x = wound and  fish = fill
pam_undisturbed_tissue_wound_no_wound %>% 
  ggplot (aes (x = wound, y = fv_fm, fill = fish))+
  geom_boxplot()+
  theme_bw()

  ## Boxplot of PAM including x = fish and fill = wound

pam_undisturbed_tissue_wound_no_wound %>% 
  ggplot (aes (x = fish, y = fv_fm, fill = wound))+
  geom_boxplot()+
  theme_bw()

pam_undisturbed_tissue_wound_no_wound %>% 
  ggplot (aes (x = wound, y = fv_fm, fill = wound))+
  geom_boxplot()+
  theme_bw()

```


### Boxplot of PAM for healed tissue
```{r}
pam_healed %>% 
  ggplot(aes (x = fish, y = fv_fm, fill = fish)) +
  geom_boxplot()+
  theme_bw()

pam_healed %>% 
  ggplot(aes (x = fish, y = fv_fm, fill = wound)) +
  geom_boxplot()+
  theme_bw()

pam_healed %>% 
  ggplot(aes (x = wound, y = fv_fm, fill = wound)) +
  geom_boxplot()+
  theme_bw()

pam_healed %>% 
  ggplot(aes (x = wound, y = fv_fm, fill = fish)) +
  geom_boxplot()+
  theme_bw()






```


### Multiple Regression

```{r}
pam_all_regression <- lmer(fv_fm ~ wound + fish + (1 | f0), data = pam_undisturbed_tissue_wound_no_wound)
summary(pam_all_regression)
anova(pam_all_regression)

pam_healed_regression <- lmer(fv_fm ~ wound + fish + (1 | f0), data = pam_healed)
summary(pam_healed_regression)
anova(pam_healed_regression)
```

### Anova
```{r}
pam_all_anova <- aov(fv_fm ~ wound * fish, data = pam_undisturbed_tissue_wound_no_wound)

summary(pam_all_anova)

pam_healed_anova <- aov(fv_fm ~ wound * fish, data = pam_healed)
```
### Tukey
```{r}
pam_all_tukey <- TukeyHSD(pam_all_anova)
pam_all_tukey

pam_healed_tukey <- TukeyHSD(pam_healed_anova)
pam_healed_tukey
```


### R2 values
```{r}

MuMIn::r.squaredGLMM(pam_all_regression)

MuMIn::r.squaredGLMM(pam_healed_regression)
```

```{r}
pam_all_predictions <- ggpredict(pam_all_regression, terms = c("wound", "fish")) %>% 
  as_tibble() %>% 
  rename(wound = group)
```

### Visualize pam_all
```{r}
pam_all_plot <- ggplot() +
  
  # plot the raw data as points
  geom_point(data = pam_undisturbed_tissue_wound_no_wound,
             aes(x = wound,
                 y = fv_fm),
             alpha = 0.5,
             color = "black",
             shape = 21) +
  
  # plot a 1:1 reference line
 # geom_abline(slope = 1, 
  #            intercept = 0,
   #           linetype = 2,
    #          linewidth = 1,
     #         color = "black") +
  
  # plot the confidence interval 
 # geom_ribbon(data = pam_all_predictions,
  #            aes(x = x,
   #               y = predicted,
    #              ymin = conf.low,
     #             ymax = conf.high),
      #        alpha = 0.2,
       #       fill = "black") +
  
  # plot the prediction line
#  geom_line(data = pam_all_predictions,
 #           aes(x = x,
  #              y = predicted),
   #         color = "black",
    #        linewidth = 1) +
  
  # labels
  labs(x = "Wound Intensity",
       y = "Photosynthetic Efficiency") 

pam_all_plot

```

### Plot TUKEY

```{r  fig.width = 20, fig.height = 40}
tukey_plot_all <- aov(fv_fm ~ wound:fish, data = pam_undisturbed_tissue_wound_no_wound)

tukey_plot_all_plot <- TukeyHSD(tukey_plot_all)
plot(tukey_plot_all_plot)


tukey_plot_healed <- aov(fv_fm~wound:fish, data = pam_healed)

tukey_healed <- TukeyHSD(tukey_plot_healed)
plot(tukey_healed)

#Seems that large: no fish is significantly different from small and large with fish; suggests that as wound size increases (high metabolic stress) fish effects emerge. within treatments with fish did not vary. and treatments within small wounds did not vary significantly from each other. #supports positive gradient hypothesis #IS THIS SUPPORTED BY BUOYANT WEIGHT DATA?
```
### RANDOMIZATION TEST ARGHHHH
```{r}
#PAM first
#looking at the mean between wounds



#Actually randomize
null_photo_dist <- replicate(1000, {
  photo_means <- pam_healed %>% 
    mutate(wound = sample(wound, n())) %>% #this shuffles the selection of data
  group_by(wound) %>% 
  summarize(mean = mean(fv_fm))

 diff_means <- photo_means$mean[2]-
  photo_means$mean[1]
 
 diff_means
})

ggplot(tibble(null_photo_dist), aes(null_photo_dist)) +
  geom_histogram(bins = 20, 
                 color = "cornflowerblue", 
                 fill = NA)+
  geom_vline(xintercept = diff_means, 
             color = "firebrick")


```
### Means between fish within wounds
```{r}
large <- pam_healed %>% 
  filter(wound == "Large")

photo_means <- large %>% 
  group_by(fish) %>% 
  summarize(mean = mean(fv_fm))

#Actually randomize
nulll_photo_dist <- replicate(1000, {
  photo_means <- large %>% 
    mutate(fish = sample(fish, n())) %>% #this shuffles the selection of data
  group_by(fish) %>% 
  summarize(mean = mean(fv_fm))

 diff_means <- photo_means$mean[2]-photo_means$mean[1]
 
 diff_means
})

ggplot(tibble(nulll_photo_dist), aes(nulll_photo_dist)) +
  geom_histogram(bins = 20, 
                 color = "cornflowerblue", 
                 fill = NA)+
  geom_vline(xintercept = diff_means, 
             color = "firebrick")




sum(abs(diff_means) > abs(diff_means))/
  length(null_photo_dist)
```
### do it for small wounds
```{r}
small <- pam_healed %>% 
  filter(wound == "Small")

photo_means <- small %>% 
  group_by(fish) %>% 
  summarize(mean = mean(fv_fm))

#Actually randomize
nullll_photo_dist <- replicate(1000, {
  photo_means <- small %>% 
    mutate(fish = sample(fish, n())) %>% #this shuffles the selection of data
  group_by(fish) %>% 
  summarize(mean = mean(fv_fm))

 diff_means <- photo_means$mean[2] - photo_means$mean[1]
 
 diff_means
})

ggplot(tibble(nullll_photo_dist), aes(nullll_photo_dist)) +
  geom_histogram(bins = 20, 
                 color = "cornflowerblue", 
                 fill = NA)+
  geom_vline(xintercept = diff_means, 
             color = "firebrick")

```



### Do it for growth
```{r}
buoy_data <- read.csv("fish_regen_buoyantweight (1).csv")
```

```{r}
null_growth_dist <- replicate(1000, {
  photo_means <- small %>% 
    mutate(fish = sample(fish, n())) %>% #this shuffles the selection of data
  group_by(fish) %>% 
  summarize(mean = mean(fv_fm))

 diff_means <- photo_means$mean[2] - photo_means$mean[1]
 
 diff_means
})

ggplot(tibble(nullll_photo_dist), aes(nullll_photo_dist)) +
  geom_histogram(bins = 20, 
                 color = "cornflowerblue", 
                 fill = NA)+
  geom_vline(xintercept = diff_means, 
             color = "firebrick")
```

### something New
```{r}
null_photo_dist <- replicate(1000, {
  photo_means <- pam_healed %>%
    mutate(wound = sample(wound, n()), #this shuffles the selection of data
                     fish_presence = sample(fish, n())) %>% #this shuffles the selection of for fish presence
  group_by(wound) %>%
  summarize(mean = mean(fv_fm))

 diff_means <- photo_means$mean[2]-
  photo_means$mean[1]

 diff_means
})

ggplot(tibble(null_photo_dist), aes(null_photo_dist)) +
  geom_histogram(bins = 20,
                 color = "cornflowerblue",
                 fill = NA)+
  geom_vline(xintercept = diff_means,
             color = "firebrick")
```